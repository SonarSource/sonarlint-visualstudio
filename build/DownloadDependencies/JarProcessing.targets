<Project>

  <!-- ************************************************************** -->
  <!-- Entry point - the Build target -->
  <!-- ************************************************************** -->

  <!-- Set Inputs and Outputs so the target only runs if the referenced jars have changed.
       We use the "EmbeddedSonarAnalyzer.props" file as the sole input file, as it specifies
       the jars to download. At the end of a build we will write a single timestamp output
       file and treat that as the sole output file.

       If the EmbeddedSonarAnalyzer.props file changes, it will have a newer timestamp than
       the timestamp output file, and MSBuild will build the project.
       If the project fails to build correctly the output file will not be updated, so the
       next time we trigger a build MSBuild will attempt to build the project again.

       Cleaning/rebuilding the project will delete the output file, so the project will then
       be built again.
    -->
  <ItemGroup>
    <InputFile Include="..\..\src\EmbeddedSonarAnalyzer.props" Visible="false" />
  </ItemGroup>

  <Target Name="Build">
    <Message Importance="high" Text="Processing analyzer jar files..." />
    <CallTarget Targets="PrepareDirectories" />
    <CallTarget Targets="DownloadIndividualJars" />
    <CallTarget Targets="DownloadSloop" />
    <CallTarget Targets="UnzipSloop" />
  </Target>

  <!-- ************************************************************** -->
  <!-- Jar processing targets -->
  <!-- ************************************************************** -->
  <Target Name="PrepareDirectories">
    <Message Importance="high" Text="[ProcessJarFiles] Ensuring download directory exists ..." />
    <MakeDir Directories="$(JarDownloadDir)" />
    <Message Importance="high" Text="[ProcessJarFiles] Download directory: $(JarDownloadDir)" />
  </Target>

  <Target Name="DownloadIndividualJars">
    <DownloadFile SourceUrl="%(PluginJars.URL)" DestinationFolder="$(JarDownloadDir)" SkipUnchangedFiles="true" Retries="3" />
  </Target>

  <Target Name ="DownloadSloop">
    <Exec Command="curl -u$(ARTIFACTORY_USER):$(ARTIFACTORY_PASSWORD) --ssl-no-revoke -C - --create-dirs --output $(SloopBinaryDownloadPath) --url $(SloopBinaryRemoteUrl)" />
  </Target>

  <Target Name="UnzipSloop">
    <Unzip SourceFiles="$(SloopBinaryDownloadPath)" DestinationFolder="$(SloopExtractDir)" OverwriteReadOnlyFiles="true" />
  </Target>
</Project>